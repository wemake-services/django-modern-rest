Returning responses
===================

Describing response
-------------------

We have two general modes of working with responses:

1. Returning real :class:`~django.http.HttpResponse` instances
   with granual configuration from "real endpoints"
2. Returning just raw data from "raw endpoints"

Real endpoints
~~~~~~~~~~~~~~

.. note::

  No response spec is generated by default for "real endpoints".

"Real endpoints" can use :func:`~django_modern_rest.endpoint.validate`
decorator, :attr:`~django_modern_rest.controller.Controller.responses`
``Controller`` attribute,
or :attr:`~django_modern_rest.settings.Settings.responses`
global setting to specify all possible responses.

To do that we utilize :class:`~django_modern_rest.metadata.ResponseSpec`:

.. literalinclude:: /examples/returning_responses/validate.py
  :caption: views.py
  :language: python
  :linenos:
  :lines: 16-
  :emphasize-lines: 11-14

``@validate`` decorator is useful but is not required
for real endpoint's declaration.
Instead, you can specify response specs in ``response`` field
of blueprint / controller / settings.

.. note::

  Note that semantic responses from auth / components / etc
  are not counted when validating real endpoints.
  You still have to use at least one explicit specification declaration.

.. literalinclude:: /examples/returning_responses/implicit_validate.py
  :caption: views.py
  :language: python
  :linenos:
  :lines: 15-
  :emphasize-lines: 10-13

If :ref:`response validation <response_validation>` passes, then it is all fine!

Raw endpoints
~~~~~~~~~~~~~

.. note::

  "Raw endpoints" always have a response spec generated by default.

"Raw endpoints" can be either undecorated
or can use :func:`~django_modern_rest.endpoint.modify` decoratator
to modify the response spec that will be **generated by default**.

.. literalinclude:: /examples/returning_responses/modify.py
  :caption: views.py
  :language: python
  :linenos:
  :lines: 10-
  :emphasize-lines: 10

Other response specs can be specified via
``extra_responses`` param to :func:`~django_modern_rest.endpoint.modify`,
:attr:`~django_modern_rest.controller.Controller.responses`
``Controller`` attribute,
or :attr:`~django_modern_rest.settings.Settings.responses` global setting.

Make sure that all responses that can be returned are described!

.. important::

  Despite the fact, that ``django-modern-rest`` does not have
  its own request and response primitives
  and uses :class:`~django.http.HttpRequest`
  and :class:`~django.http.HttpResponse`,
  users must not return Django responses directly.

  Instead, use any of the public APIs:

  - :meth:`~django_modern_rest.controller.Controller.to_response`
  - :meth:`~django_modern_rest.controller.Controller.to_error`
  - :exc:`~django_modern_rest.response.APIError`

  In case when you don't have a controller / endpoint instance
  (like in a middleware, for example),
  you can fallback to using :func:`~django_modern_rest.response.build_response`
  lower level primitive.

  Why?

  1. You can mess up the default headers / status codes
  2. You won't have the right json serializer / deserializer,
     which can be both slow and error-prone


Describing headers
------------------

You also must specify which headers are returned (if any).

When using "real endpoints", you can provide ``headers`` parameter
to :class:`~django_modern_rest.metadata.ResponseSpec`
if there are headers you want to describe.
:class:`~django_modern_rest.headers.HeaderSpec` is here to help.
You can create both ``required=True``
(always must be present on the response object)
and ``required=False`` headers (might be missing in some cases):

.. literalinclude:: /examples/returning_responses/validate_headers.py
  :caption: views.py
  :language: python
  :linenos:
  :lines: 18-
  :emphasize-lines: 14-17

.. note::

  All headers from the response objects are checked. We will report:

  - Required headers that exist in the spec, but not on the ``response``
  - Any headers that exist on the ``response``, but not present in the spec

  ``Content-Type`` header is the only one that is always added automatically.

With "raw endpoints" you can also use
:class:`~django_modern_rest.headers.NewHeader` marker which can set headers
with known values to the final response.

.. literalinclude:: /examples/returning_responses/modify_headers.py
  :caption: views.py
  :language: python
  :linenos:
  :lines: 10-
  :emphasize-lines: 13

If you need headers with not static, but dynamic values, use "real endpoints"
and pass ``headers`` dict to
:meth:`~django_modern_rest.controller.Controller.to_response` method.

The last important thing about headers
is :attr:`~django_modern_rest.headers.HeaderSpec.schema_only` attribute.
It is used to describe headers that:

1. Will be set in the response by someone else outside the framework,
   like HTTP proxy or Django's own middleware.
   See :class:`django.contrib.sessions.middleware.SessionMiddleware`
   as a notable example
2. Will be validated to be **NOT** present in the response from our framework.
   Since it is designed to be added later, it should not be already present

.. important::

  Header definitions are case insensitive according to the HTTP spec.
  ``Session`` and ``session`` is the same header.


Describing cookies
------------------

.. warning::

  Some may say that returning cookies is not "RESTful",
  because cookies is an implicit state, that RESTful APIs must not have.
  Be careful, only use this feature when you need to.

  See: https://parottasalna.hashnode.dev/is-it-okay-to-add-cookie-to-a-rest-api

We also support setting and validating response cookies.

You can use :class:`~django_modern_rest.cookies.NewCookie`
to add new cookies with statically known values to "raw endpoints".
Or :class:`~django_modern_rest.cookies.CookieSpec` with both types
of endpoints to describe response cookies.

.. literalinclude:: /examples/returning_responses/modify_cookies.py
  :caption: views.py
  :language: python
  :linenos:
  :lines: 9-
  :emphasize-lines: 12

And you can set any cookies to :attr:`django.http.HttpResponse.cookies`
with "real endpoints". Since we have strict schemas,
it is required to describe the set cookies with
:class:`~django_modern_rest.cookies.CookieSpec`:

.. literalinclude:: /examples/returning_responses/validate_cookies.py
  :caption: views.py
  :language: python
  :linenos:
  :lines: 19-
  :emphasize-lines: 14-17, 24-26

The last important thing about cookies
is :attr:`~django_modern_rest.cookies.CookieSpec.schema_only` attribute.
It is used to describe cookies that:

1. Will be set in the response by someone else outside the framework,
   like HTTP proxy or Django's own middleware.
   See :class:`django.contrib.sessions.middleware.SessionMiddleware`
   as a notable example
2. Will be validated to be **NOT** present in the response from our framework.
   Since it is designed to be added later, it should not be already present

.. note::

  All cookie parts are validated by default. Except ``expires`` field,
  because it is relative to the current time.

.. important::

  Coookie definitions are case sensitive according to the HTTP spec.
  ``Session`` and ``session`` are two different cookies.


Redirects
---------

We support returning redirects from API endpoins with
:class:`~django_modern_rest.response.APIRedirectError` custom exception:

.. literalinclude:: /examples/returning_responses/redirect_error.py
  :caption: views.py
  :language: python
  :linenos:

And default Django's :class:`django.http.HttpResponseRedirect`:

.. literalinclude:: /examples/returning_responses/redirect_response.py
  :caption: views.py
  :language: python
  :linenos:


Files
-----

We support file and other binary responses.

.. warning::

  Returning files via Python and Django in particular
  is very performance inefficient.
  It should not be used for anything serious.

  Instead return files with S3-like systems or at least on a proxy-server level.

To do so, you should mark your
:class:`~django_modern_rest.metadata.ResponseSpec`
with a :class:`~django_modern_rest.openapi.markers.Binary` marker:

.. literalinclude:: /examples/returning_responses/file_response.py
  :caption: views.py
  :language: python
  :linenos:


.. _response_validation:

Response validation
-------------------

By default, all responses are validated at runtime to match the schema.
This allows us to be super strict about schema generation as a pro,
but as a con, it is slower than can possibly be.

You can disable response validation via configuration:

.. warning::

  Disabling response validation makes sense only
  in production for better performance.

  It is not recommended to disable response validation for any other reason.
  Instead, fix your schema errors!

.. tabs::

    .. tab:: Active validation

      .. literalinclude:: /examples/returning_responses/active_validation.py
        :caption: views.py
        :language: python
        :linenos:
        :emphasize-lines: 26-27

    .. tab:: Disable per endpoint

      .. literalinclude:: /examples/returning_responses/per_endpoint.py
        :caption: views.py
        :language: python
        :linenos:
        :emphasize-lines: 6, 24

    .. tab:: Disable per blueprint

      .. literalinclude:: /examples/returning_responses/per_blueprint.py
        :caption: views.py
        :language: python
        :linenos:
        :emphasize-lines: 6, 24

    .. tab:: Disable per controller

      .. literalinclude:: /examples/returning_responses/per_controller.py
        :caption: views.py
        :language: python
        :linenos:
        :emphasize-lines: 24-25

    .. tab:: Disable globally

      .. code-block:: python
        :caption: settings.py

        >>> DMR_SETTINGS = {'validate_responses': False}

    .. tab:: :octicon:`checklist` The right way

      The "right way" is not to disable the validation,
      but to specify the correct schema to be returned from an endpoint.

      .. literalinclude:: /examples/returning_responses/right_way.py
        :caption: views.py
        :language: python
        :linenos:
        :emphasize-lines: 11-12, 31-38
